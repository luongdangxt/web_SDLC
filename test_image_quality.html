<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image Quality</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .image-comparison { display: flex; gap: 20px; margin: 10px 0; }
        .image-container { text-align: center; }
        .image-container img { max-width: 200px; max-height: 200px; border: 2px solid #ccc; }
        .debug-info { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Test Image Quality</h1>
    
    <div class="test-case">
        <h3>Upload Test Image</h3>
        <input type="file" id="test-image" accept="image/*" onchange="testImageQuality(this)">
        <div id="image-comparison" class="image-comparison"></div>
        <div id="debug-info" class="debug-info"></div>
    </div>

    <script>
        function testImageQuality(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const originalDataUrl = e.target.result;
                
                // Create a copy to simulate what we store in database
                const base64Data = originalDataUrl.split(',')[1];
                const mimeType = originalDataUrl.split(':')[1].split(';')[0];
                const reconstructedDataUrl = `data:${mimeType};base64,${base64Data}`;
                
                // Display both images
                const comparison = document.getElementById('image-comparison');
                comparison.innerHTML = `
                    <div class="image-container">
                        <h4>Original</h4>
                        <img src="${originalDataUrl}" alt="Original">
                    </div>
                    <div class="image-container">
                        <h4>Reconstructed</h4>
                        <img src="${reconstructedDataUrl}" alt="Reconstructed">
                    </div>
                `;
                
                // Debug info
                const debugInfo = document.getElementById('debug-info');
                debugInfo.innerHTML = `
                    <strong>File Info:</strong><br>
                    Name: ${file.name}<br>
                    Size: ${file.size} bytes<br>
                    Type: ${file.type}<br>
                    <br>
                    <strong>Data URL Info:</strong><br>
                    Original length: ${originalDataUrl.length}<br>
                    Reconstructed length: ${reconstructedDataUrl.length}<br>
                    Base64 length: ${base64Data.length}<br>
                    MIME type: ${mimeType}<br>
                    <br>
                    <strong>Quality Check:</strong><br>
                    Original equals reconstructed: ${originalDataUrl === reconstructedDataUrl}<br>
                    Both images load successfully: ${originalDataUrl.startsWith('data:image') && reconstructedDataUrl.startsWith('data:image')}
                `;
                
                // Test upload to our API
                testUploadToAPI(file);
            };
            reader.readAsDataURL(file);
        }

        function testUploadToAPI(file) {
            const formData = new FormData();
            formData.append('avatar', file);

            fetch('upload_avatar.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const debugInfo = document.getElementById('debug-info');
                debugInfo.innerHTML += `
                    <br>
                    <strong>API Response:</strong><br>
                    Success: ${data.success}<br>
                    Message: ${data.message}<br>
                    Avatar URL length: ${data.avatar_url ? data.avatar_url.length : 'N/A'}<br>
                    <br>
                    <strong>Retrieved Image:</strong><br>
                `;
                
                if (data.success && data.avatar_url) {
                    const retrievedImg = document.createElement('img');
                    retrievedImg.src = data.avatar_url;
                    retrievedImg.style.maxWidth = '200px';
                    retrievedImg.style.maxHeight = '200px';
                    retrievedImg.style.border = '2px solid #007bff';
                    retrievedImg.alt = 'Retrieved from API';
                    
                    const container = document.createElement('div');
                    container.innerHTML = '<h4>From Database</h4>';
                    container.appendChild(retrievedImg);
                    
                    document.getElementById('image-comparison').appendChild(container);
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                document.getElementById('debug-info').innerHTML += `<br><strong>Error:</strong> ${error.message}`;
            });
        }
    </script>
</body>
</html> 