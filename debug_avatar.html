<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Avatar Color Issue</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .image-display { display: flex; gap: 20px; margin: 10px 0; }
        .image-box { text-align: center; }
        .image-box img { width: 150px; height: 150px; object-fit: cover; border: 2px solid #333; }
        .color-info { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Debug Avatar Color Issue</h1>
    
    <div class="debug-section">
        <h3>1. Upload Test Image</h3>
        <input type="file" id="test-file" accept="image/*" onchange="analyzeImage(this)">
        <div id="image-analysis"></div>
    </div>
    
    <div class="debug-section">
        <h3>2. Test Current Avatar</h3>
        <button onclick="getCurrentAvatar()">Get Current Avatar</button>
        <div id="current-avatar"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. Check Database Field</h3>
        <button onclick="checkDatabaseField()">Check Database Field</button>
        <div id="database-info"></div>
    </div>

    <script>
        function analyzeImage(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                
                // Create canvas to analyze image
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // Get image data to check colors
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Analyze colors
                    let hasColor = false;
                    let colorCount = 0;
                    let grayCount = 0;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // Check if pixel has color (not grayscale)
                        if (Math.abs(r - g) > 10 || Math.abs(r - b) > 10 || Math.abs(g - b) > 10) {
                            hasColor = true;
                            colorCount++;
                        } else {
                            grayCount++;
                        }
                    }
                    
                    const analysis = document.getElementById('image-analysis');
                    analysis.innerHTML = `
                        <div class="image-display">
                            <div class="image-box">
                                <h4>Original Image</h4>
                                <img src="${dataUrl}" alt="Original">
                            </div>
                        </div>
                        <div class="color-info">
                            <strong>Image Analysis:</strong><br>
                            Dimensions: ${img.width} x ${img.height}<br>
                            File size: ${file.size} bytes<br>
                            File type: ${file.type}<br>
                            Data URL length: ${dataUrl.length}<br>
                            <br>
                            <strong>Color Analysis:</strong><br>
                            Has color: ${hasColor}<br>
                            Color pixels: ${colorCount}<br>
                            Gray pixels: ${grayCount}<br>
                            Color percentage: ${((colorCount / (colorCount + grayCount)) * 100).toFixed(2)}%<br>
                            <br>
                            <strong>Base64 Info:</strong><br>
                            Starts with data:image: ${dataUrl.startsWith('data:image')}<br>
                            MIME type: ${dataUrl.split(':')[1].split(';')[0]}
                        </div>
                    `;
                    
                    // Test upload
                    testUpload(file, dataUrl);
                };
                
                img.src = dataUrl;
            };
            reader.readAsDataURL(file);
        }

        function testUpload(file, originalDataUrl) {
            const formData = new FormData();
            formData.append('avatar', file);

            fetch('upload_avatar.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const analysis = document.getElementById('image-analysis');
                    analysis.innerHTML += `
                        <div class="image-display">
                            <div class="image-box">
                                <h4>After Upload</h4>
                                <img src="${data.avatar_url}" alt="Uploaded">
                            </div>
                        </div>
                        <div class="color-info">
                            <strong>Upload Result:</strong><br>
                            Success: ${data.success}<br>
                            URL length: ${data.avatar_url.length}<br>
                            URLs match: ${originalDataUrl === data.avatar_url}<br>
                            <br>
                            <strong>Quality Check:</strong><br>
                            Original starts with data:image: ${originalDataUrl.startsWith('data:image')}<br>
                            Uploaded starts with data:image: ${data.avatar_url.startsWith('data:image')}<br>
                            <br>
                            <strong>Debug Info:</strong><br>
                            Original first 100 chars: ${originalDataUrl.substring(0, 100)}<br>
                            Uploaded first 100 chars: ${data.avatar_url.substring(0, 100)}
                        </div>
                    `;
                } else {
                    console.error('Upload failed:', data.message);
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
            });
        }

        function getCurrentAvatar() {
            fetch('get_profile.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.user.Avatar) {
                        const container = document.getElementById('current-avatar');
                        container.innerHTML = `
                            <div class="image-display">
                                <div class="image-box">
                                    <h4>Current Avatar</h4>
                                    <img src="${data.user.Avatar}" alt="Current Avatar">
                                </div>
                            </div>
                            <div class="color-info">
                                <strong>Current Avatar Info:</strong><br>
                                Avatar exists: ${!!data.user.Avatar}<br>
                                Avatar length: ${data.user.Avatar.length}<br>
                                Starts with data:image: ${data.user.Avatar.startsWith('data:image')}<br>
                                MIME type: ${data.user.Avatar.split(':')[1].split(';')[0]}
                            </div>
                        `;
                    } else {
                        document.getElementById('current-avatar').innerHTML = '<p>No avatar found</p>';
                    }
                })
                .catch(error => {
                    console.error('Error getting avatar:', error);
                });
        }

        function checkDatabaseField() {
            fetch('check_avatar_field.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('database-info');
                        container.innerHTML = `
                            <div class="color-info">
                                <strong>Database Field Info:</strong><br>
                                Field type: ${data.field_info.type}<br>
                                Null allowed: ${data.field_info.null}<br>
                                Default: ${data.field_info.default}<br>
                                Extra: ${data.field_info.extra}<br>
                                <br>
                                <strong>Current Avatar Data:</strong><br>
                                Has avatar: ${data.user.has_avatar}<br>
                                Avatar length: ${data.user.avatar_length}<br>
                                Starts with data:image: ${data.user.avatar_starts_with_data}<br>
                                MIME type: ${data.user.avatar_mime_type || 'N/A'}
                            </div>
                        `;
                    } else {
                        document.getElementById('database-info').innerHTML = `<p>Error: ${data.message}</p>`;
                    }
                })
                .catch(error => {
                    console.error('Error checking database field:', error);
                });
        }
    </script>
</body>
</html> 